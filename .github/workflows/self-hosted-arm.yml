name: Build, run test and upload binaries 

on: [push, pull_request]

jobs:

  linux-clang:
    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v2

    - name: Get current date
      id: date
      run: echo "::set-output name=date::$(date +'%Y-%m-%dT%H%M')"

    - name: Install build dependencies
      run: sudo apt -y update && sudo apt -y install libpcap-dev libsdl-dev netcat-openbsd

    - name: Create build environment
      run: cmake -E make_directory ${{runner.workspace}}/build

    - name: Configure CMake
      shell: bash
      working-directory: ${{runner.workspace}}/build
      run: cmake $GITHUB_WORKSPACE -DCMAKE_C_COMPILER="clang" -DCMAKE_CXX_COMPILER="clang++" -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_FLAGS="-Wall"

    - name: Build
      working-directory: ${{runner.workspace}}/build
      shell: bash
      run: cmake --build . --config Release
      env:
        MAKEFLAGS: "-j2"

    - name: Run test scripts
      working-directory: ${{runner.workspace}}/axpbox
      shell: bash
      run: ${{runner.workspace}}/axpbox/test/run

    - name: Upload AXPbox binary
      uses: actions/upload-artifact@v1
      with:
        name: AXPbox-linux-clang-${{ env.BUILD_DATE }}
        path: ${{runner.workspace}}/build/axpbox 
      env:
        BUILD_DATE: ${{ steps.date.outputs.date }}

  linux-gcc:
    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v2

    - name: Get current date
      id: date
      run: echo "::set-output name=date::$(date +'%Y-%m-%dT%H%M')"

    - name: Install build dependencies
      run: sudo apt -y update && sudo apt -y install libpcap-dev libsdl-dev netcat-openbsd

    - name: Create build environment
      run: cmake -E make_directory ${{runner.workspace}}/build

    - name: Configure CMake
      shell: bash
      working-directory: ${{runner.workspace}}/build
      run: cmake $GITHUB_WORKSPACE -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER="gcc" -DCMAKE_CXX_COMPILER="g++" -DCMAKE_CXX_FLAGS="-Wall"

    - name: Build
      working-directory: ${{runner.workspace}}/build
      shell: bash
      run: cmake --build . --config Release
      env:
        MAKEFLAGS: "-j2"

    - name: Run test scripts
      working-directory: ${{runner.workspace}}/axpbox
      shell: bash
      run: ${{runner.workspace}}/axpbox/test/run

    - name: Upload AXPbox binary
      uses: actions/upload-artifact@v1
      with:
        name: AXPbox-linux-gcc-${{ env.BUILD_DATE }}
        path: ${{runner.workspace}}/build/axpbox
      env:
        BUILD_DATE: ${{ steps.date.outputs.date }} 
